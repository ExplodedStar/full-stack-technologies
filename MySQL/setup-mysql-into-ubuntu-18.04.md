# Как установить MySQL в Ubuntu 18.04

## Введение

[Как установить MySQL в Ubuntu 18.04 оригинал](https://www.digitalocean.com/community/tutorials/mysql-ubuntu-18-04-ru)

MySQL является системой управления базами данных с открытым исходным кодом и обычно используется, как часть популярного стека LAMP (Linux, Apache, MySQL, PHP/Python/Perl). MySQL использует реляционную базу данных и SQL (Structured Query Language, язык структурированных запросов) для управления данными.

Короткая версия установки очень проста: достаточно обновить индекс пакетов, установить пакет mysql-server, а затем запустить скрипт настройки безопасности.

```bash
sudo apt update
sudo apt install mysql-server
sudo mysql_secure_installation
```

Это руководство описывает процесс установки MySQL версии 5.7 на сервер с Ubuntu 18.04. Если вам необходимо обновить установленную ранее версию MySQL до версии 5.7, вы можете ознакомиться с руководством по обновлению MySQL до версии 5.7.

## Необходимые условия

Перед тем, как начать следовать шагам, описанным в этом руководстве, вам необходимо настроить отдельный, не-рутовый (non-root) профиль пользователя на вашем сервере с Ubuntu 18.04. Вы можете сделать это используя нашу статью о первичной настройке сервера на Ubuntu 18.04.

## Шаг 1 - Установка MySQL

По умолчанию в репозиторий пакетов APT в Ubuntu 18.04 включена только последняя версия MySQL. На момент написания этого руководства это MySQL 5.7.

Для установки этой версии обновите индекс пакетов `apt` командой:

```bash
sudo apt update
```

Затем установите пакет:

```bash
sudo apt install mysql-server
```

Эта команда установит MySQL, но при этом вам не будет предложено задать пароль или внести какие-либо правки в конфигурацию. Поскольку это делает установку небезопасной, рассмотрим далее, как настроить установленную MySQL.

## Шаг 2 - Настройка MySQL

В случае новой установки MySQL вам необходимо выполнить скрипт безопасности. Он изменяет некоторые настройки по умолчанию на более безопасные, например, удалённый вход для пользователей root и пользователи, созданные по умолчанию. В старых версиях MySQL вам было необходимо также инициализировать директорию данных вручную, теперь это делается автоматически.

Выполните скрипт безопасности командой:

```bash
sudo mysql_secure_installation
```

В результате выполнения этого скрипта вам будет предложено внести изменения в настройки безопасности вашей MySQL. Сначала вам будет предложено установить плагин валидации паролей (Validate Password Plugin), который позволяет тестировать надёжность паролей MySQL. Далее вам предложат задать пароль для пользователя root вашей установки MySQL. Выберите надёжный пароль и введите его два раза.

Далее вы можете выбирать Y и нажимать ENTER для всех последующих вопросов. При этом будут удалены некоторые анонимные пользователи и тестовые базы данных, будет отключена возможность удалённого входа для root пользователей, после чего все внесённые изменения будут применены к вашей установке MySQL.

Для инициализации директории данных MySQL вам необходимо использовать `mysql_install_db` для версий меньше, чем 5.7.6, и `mysqld --initialize` для версии 5.7.6 и более поздних версий. При этом, если вы устанавливаете MySQL для Debian как описано на шаге 1, директория данных будет создана автоматически и вам нет необходимости что-то делать. Если вы при этом попытаетесь всё равно выполнить команду создания директории данных, вы увидите следующую ошибку:

```bash
# Вывод
mysqld: Can't create directory '/var/lib/mysql/' (Errcode: 17 - File exists)
2018-04-23T13:48:00.572066Z 0 [ERROR] Aborting
```

Обратите внимание, несмотря на то, что вы задали пароль для пользователя root для MySQL, этот пользователь не настроен для аутентификации по паролю при подключении к оболочке (shell) MySQL. Вы можете изменить эту настройку на следующем шаге 3.

## Шаг 3 - (Опционально) Настройка аутентификации и привилегий

На серверах с Ubuntu, использующей MySQL 5.7 (и более поздние версии), пользователь root в MySQL по умолчанию аутентифицируется с помощью плагина auth_socket, а не по паролю. Это в целом более безопасно и удобно во многих случаях, но не в случае, когда вам необходимо организовать доступ к MySQL со стороны сторонней программы, например, phpMyAdmin.

Для того, чтобы пользователь root в MySQL мог использовать пароль для входа в систему вам необходимо изменить метод аутентификации с auth_socket на mysql_native_password. Для этого войдите в оболочку MySQL следующей командой:

```bash
sudo mysql
```

Далее проверьте, какой метод аутентификации используется для каждого из ваших пользователей MySQL:


```bash
SELECT user,authentication_string,plugin,host FROM mysql.user;
```

В этом примере ваш пользователь root использует аутентификацию с помощью плагина auth_socket. Для изменения этой настройки на использование пароля используйте следующую команду ALTER USER. Не забудьте изменить password на ваш сильный пароль:

```bash
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'Video300';
```

Далее выполните команду FLUSH PRIVILEGES, которая применит внесённые изменения:

```bash 
FLUSH PRIVILEGES;
```

Проверьте методы авторизации для пользователей ещё раз для того, чтобы убедиться, что пользователь root более не использует плагин auth_socket для авторизации:

```bash 
SELECT user,authentication_string,plugin,host FROM mysql.user;
```

Как можно видеть на представленном выводе теперь root пользователь MySQL аутентифицируется с использованием пароля. После того, как мы в этом убедились, можно выйти из оболочки MySQL:

```bash
exit
```

В некоторых случаях бывает полезно использовать для входа в MySQL отдельного пользователя. Для создания такого пользователя войдите в оболочку MySQL:

```bash
sudo mysql
```

**Внимание: Если вы включили вход по паролю для пользователя root, как описано выше, вам потребуется использовать другую команду для входа в оболочку MySQL. Команда выше запустит оболочку с привилегиями обычного пользователя, для получения привилегий администратора вам необходимо выполнить следующую команду:**

```bash
mysql -u root -p
```

Далее создайте нового пользователя и задайте для него надёжный пароль:

```bash
CREATE USER 'sammy'@'localhost' IDENTIFIED BY 'password';
```

Далее задайте для пользователя подходящий набор привилегий. Например, вы можете дать пользователю доступ ко всем таблицами в базе данных, а также права на добавление, изменение и удаление пользовательских привилегий следующей командой:

```bash
GRANT ALL PRIVILEGES ON *.* TO 'sammy'@'localhost' WITH GRANT OPTION;
```

Обратите внимание на то, что в этом случае вам нет необходимости выполнять команду FLUSH PRIVILEGES. Эта команда необходимо только тогда, когда вы изменяете таблицы доступа (grant tables) используя команды INSERT, UPDATE или DELETE. Поскольку вы создали нового пользователя, а не редактируете права существующего пользователя, команда FLUSH PRIVILEGES не является необходимой.

После этого, выйдите из оболочки MySQL:

```bash
exit
```

Теперь мы можем протестировать нашу установку MySQL.

## Шаг 4 - Тестирование MySQL

Вне зависимости от того, как именно вы установили MySQL, она должна запуститься автоматически. Проверим это следующей командой:

```bash
systemctl status mysql.service
```

Если MySQL не запущена, вы можете запустить её с помощью команды sudo systemctl start mysql.

Для дополнительной проверки вы можете попробовать подключиться к базе данных с помощью инструмента mysqladmin, который представляет собой клиент, позволяющий запускать административные команды. Например, эта команда приказывает подключиться к MySQL в качестве пользователя root (-u root), запросить пароль (-p) и вернуть версию.

```bash
sudo mysqladmin -p -u root version
```

## Открываем удалённый доступ MySQL

Разрешаем подключение к порту 3306:

```bash
sudo ufw allow 3306/tcp
```

В файле /etc/mysql/mysql.conf.d/mysqld.cnf редактируем следующую строчку:
```txt
bind-address = 127.0.0.1
```

на: 


```txt
bind-address = 0.0.0.0
```

Перезапускаем MySQL:

```bash
sudo service mysql restart
```

Заходим в MySQL:

```bash
sudo mysql -u root
```

Создаем нового пользователя с привелегиями:

```bash
CREATE USER 'username'@'%' IDENTIFIED BY 'xxxxxxxx';
GRANT ALL PRIVILEGES ON * . * TO 'username'@'%';
FLUSH PRIVILEGES;
```

## Рестарт MySQL после перезагрузки

```bash
sudo systemctl edit mysql
```

```txt
[Service]
Restart=always
```

## Заключение

Теперь на вашем сервере установлена и настроена MySQL. Вот несколько примеров того, что можно сделать дальше:

[Реализовать некоторые дополнительные меры безопасности.](https://www.digitalocean.com/community/tutorials/how-to-secure-mysql-and-mariadb-databases-in-a-linux-vps)
[Переместить директорию данных.](https://www.digitalocean.com/community/tutorials/how-to-move-a-mysql-data-directory-to-a-new-location-on-ubuntu-16-04)
[Управлять вашими серверами MySQL с помощью SaltStack.](https://www.digitalocean.com/community/tutorials/saltstack-infrastructure-creating-salt-states-for-mysql-database-servers)



